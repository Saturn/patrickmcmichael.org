{"componentChunkName":"component---src-templates-blog-post-js","path":"/flask-google-login/","result":{"data":{"site":{"siteMetadata":{"title":"patrickmcmichael.org","author":"Patrick McMichael"}},"markdownRemark":{"id":"e5e53bfe-b72a-5b99-b9ed-2ea24836aaa2","excerpt":"If you are building a Flask application that includes user authentication you may have considered adding the ability for users to authenticate using a third…","html":"<p>If you are building a Flask application that includes user authentication you may have considered adding the ability for users to authenticate using a third-party account such as Google, Facebook or Twitter. I will show an example Flask application which uses Google as an authentication provider. However, it will be very straightforward to add support for other providers too.</p>\n<p>Before I get to the Flask app, I want to quickly go over some OAuth 2 basics. If you wish to skip ahead to the example Flask app click <a href=\"#the-example-application\">here</a>.</p>\n<h2 id=\"oauth-2-and-openid-connect\" style=\"position:relative;\"><a href=\"#oauth-2-and-openid-connect\" aria-label=\"oauth 2 and openid connect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OAuth 2 and OpenID Connect</h2>\n<p><a href=\"https://oauth.net/2/\">OAuth 2</a> is a specification or standard which can enable applications to obtain (limited) access to data on another service such as Google, Facebook or Spotify for example. Services may authorize access to different levels of data ranging from basic account information all the way to wanting access to your emails (<a href=\"https://developers.google.com/gmail/api/guides/\">Gmail API</a>). Specifically, OAuth 2 is an authorization framework. It does not specify exactly how services should handle authentication.</p>\n<p><a href=\"https://openid.net/connect/\">OpenID Connect</a> is an identity layer built on top of OAuth 2. OpenID Connect is helpful because it defines some extra steps to the OAuth 2 flow which make federated authentication possible. One of the main steps is the returning of an <em>id_token</em> from the authorization server. This token is usually a JSON Web Token (<a href=\"https://jwt.io/\">JWT</a>) which serializes various data such as <em>iss</em> (issuer) and <em>iat</em> (issued at). They can include additional data. For example, Google’s id_tokens do include email addresses (assuming ‘email’ is part of the scope you specified when initiating the request).</p>\n<h3 id=\"the-general-flow\" style=\"position:relative;\"><a href=\"#the-general-flow\" aria-label=\"the general flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The General Flow</h3>\n<p>The general back and forth login flow between a client (you, the user), a website (consumer) and the auth provider can look something like this:</p>\n<ol>\n<li>Client initiates request to sign in.</li>\n<li>The consumer redirects client to authentication provider.</li>\n<li>The provider displays a sign in page, usually with some information on the consumer including what they have requested access to. Some providers may allow the client to modify the permissions requested. For authentication, usually basic profile information is all that is requested (email, name etc).</li>\n<li>The client confirms they wish to continue signing in. The provider creates a URL that directs them back to the consumer. This URL will contain <em>state</em> and <em>code</em> parameters.</li>\n<li>The consumer verifies the <em>state</em> token has not changed. The consumer then makes a request to the provider and passes along the <em>code</em> which is verified by the provider.</li>\n<li>If verification succeeds, the provider creates an <em>access token</em> and then returns this to the consumer.</li>\n<li>Once the consumer has the <em>access token</em>, they can log the user in. They can use the <em>access token</em> to possibly make more requests on behalf of the client.</li>\n</ol>\n<p>For more detail on the OAuth 2 flow check <a href=\"https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2\">Digital Ocean’s</a> article which goes into a good amount of detail.</p>\n<p>For this example Flask application I will be using <a href=\"https://developers.google.com/identity/protocols/OpenIDConnect\">Google</a> as an authentication provider. Their implementation conforms to OpenID Connect.</p>\n<h2 id=\"the-example-application\" style=\"position:relative;\"><a href=\"#the-example-application\" aria-label=\"the example application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Example Application</h2>\n<h3 id=\"getting-the-credentials\" style=\"position:relative;\"><a href=\"#getting-the-credentials\" aria-label=\"getting the credentials permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting the credentials</h3>\n<ol>\n<li>To be able to use Google as an authentication provider for our application we need to register an application in the <a href=\"https://console.developers.google.com/apis/credentials\">Google developer console</a>. Create a new ‘project’ for this.</li>\n<li>Select <em>Create credentials</em> and then <em>OAuth client id</em>. Choose <em>Web application</em> for <em>Application type</em>.</li>\n<li>Choose a <em>name</em> for the application and add <em><a href=\"http://localhost:5000/google/authorized\">http://localhost:5000/google/authorized</a></em> to the <em>Authorised redirect URIs</em> section. Click save and make a note of the Client Secret and Client ID displayed.</li>\n</ol>\n<h3 id=\"install-dependencies\" style=\"position:relative;\"><a href=\"#install-dependencies\" aria-label=\"install dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install dependencies</h3>\n<deckgo-highlight-code  line-numbers=\"true\"  >\n          <code slot=\"code\">$ pip install flask flask-dance[sqla] flask-sqlalchemy blinker</code>\n        </deckgo-highlight-code>\n<p>I am using <a href=\"https://github.com/singingwolfboy/flask-dance\">Flask-Dance</a> because it is actively maintained, well documented and comes with quite a lot of built in providers.</p>\n<h3 id=\"the-code\" style=\"position:relative;\"><a href=\"#the-code\" aria-label=\"the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Code</h3>\n<deckgo-highlight-code language=\"python\" line-numbers=\"true\"  >\n          <code slot=\"code\">import os\n\nfrom flask import Flask, render_template, redirect, url_for\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import (LoginManager, UserMixin,\n                         current_user, login_user, logout_user)\nfrom flask_dance.consumer import oauth_authorized\nfrom flask_dance.contrib.google import make_google_blueprint, google\nfrom flask_dance.consumer.backend.sqla import (OAuthConsumerMixin,\n                                               SQLAlchemyBackend)\n\n\nos.environ[&#39;OAUTHLIB_INSECURE_TRANSPORT&#39;] = &#39;1&#39;\n\npath = os.path.dirname(os.path.realpath(__file__))\ndb_path = os.path.join(path, &#39;app.db&#39;)\n\napp = Flask(__name__)\napp.config[&#39;SQLALCHEMY_DATABASE_URI&#39;] = &#39;sqlite:///&#39; + db_path\napp.config[&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;] = False\napp.config[&#39;SECRET_KEY&#39;] = &#39;YOUR-SECRET-KEY-HERE&#39;\n\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = &#39;google.login&#39;\n\n\nclass User(db.Model, UserMixin):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(256), unique=True)\n    name = db.Column(db.String(256))\n\n\nclass OAuth(OAuthConsumerMixin, db.Model):\n    provider_user_id = db.Column(db.String(256), unique=True)\n    user_id = db.Column(db.Integer, db.ForeignKey(&#39;user.id&#39;))\n    user = db.relationship(User)\n\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n\ngoogle_blueprint = make_google_blueprint(\n    client_id=&#39;YOUR-CLIENT-ID-HERE&#39;,\n    client_secret=&#39;YOUR-CLIENT-SECRET-HERE&#39;,\n    scope=[&#39;https://www.googleapis.com/auth/userinfo.email&#39;,\n           &#39;https://www.googleapis.com/auth/userinfo.profile&#39;],\n    offline=True,\n    reprompt_consent=True,\n    backend=SQLAlchemyBackend(OAuth, db.session, user=current_user)\n)\n\napp.register_blueprint(google_blueprint)\n\n\n@app.route(&#39;/&#39;)\ndef index():\n    google_data = None\n    user_info_endpoint = &#39;/oauth2/v2/userinfo&#39;\n    if current_user.is_authenticated and google.authorized:\n        google_data = google.get(user_info_endpoint).json()\n    return render_template(&#39;index.j2&#39;,\n                           google_data=google_data,\n                           fetch_url=google.base_url + user_info_endpoint)\n\n\n@app.route(&#39;/logout&#39;)\ndef logout():\n    logout_user()\n    return redirect(url_for(&#39;index&#39;))\n\n\n@oauth_authorized.connect_via(google_blueprint)\ndef google_logged_in(blueprint, token):\n    resp = blueprint.session.get(&#39;/oauth2/v2/userinfo&#39;)\n    user_info = resp.json()\n    user_id = str(user_info[&#39;id&#39;])\n    oauth = OAuth.query.filter_by(provider=blueprint.name,\n                                  provider_user_id=user_id).first()\n    if not oauth:\n        oauth = OAuth(provider=blueprint.name,\n                      provider_user_id=user_id,\n                      token=token)\n    else:\n        oauth.token = token\n        db.session.add(oauth)\n        db.session.commit()\n        login_user(oauth.user)\n    if not oauth.user:\n        user = User(email=user_info[&quot;email&quot;],\n                    name=user_info[&quot;name&quot;])\n        oauth.user = user\n        db.session.add_all([user, oauth])\n        db.session.commit()\n        login_user(user)\n\n    return False</code>\n        </deckgo-highlight-code>\n<h3 id=\"the-template\" style=\"position:relative;\"><a href=\"#the-template\" aria-label=\"the template permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Template</h3>\n<deckgo-highlight-code language=\"django\" line-numbers=\"true\"  >\n          <code slot=\"code\">&lt;!doctype html&gt;\n&lt;html class=&quot;no-js&quot; lang=&quot;&quot;&gt;\n\n&lt;head&gt;\n  &lt;title&gt;Google Login with Flask&lt;/title&gt;\n  &lt;style&gt;\n  body {\n    font-family: sans-serif;\n  }\n  .info {\n    margin: 0;\n    padding-left: 5px;\n    border: solid gold 3px;\n    background-color: beige;\n    font-family: monospace;\n  }\n  .info p {\n    margin:  0;\n  }\n  .info p:first-child {\n    font-size: 15px;\n    padding-bottom: 10px;\n  }\n&lt;/style&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n\n  &lt;h3&gt;Hello world! This is a Flask application.&lt;/h3&gt;\n  {% if not current_user.is_authenticated %}\n    &lt;p&gt;Click &lt;a href=&quot;/google&quot;&gt;here&lt;/a&gt; to login with a Google Account.&lt;/p&gt;\n  {% else %}\n    &lt;p&gt;Hi, {{ current_user.name }} [&lt;strong&gt;{{ current_user.email }}&lt;/strong&gt;]. You have logged in using a Google Account.&lt;/p&gt;\n  {% if google_data is not none %}\n    &lt;div class=&quot;info&quot;&gt;\n      &lt;p&gt;User info fetched from &lt;strong&gt;{{ fetch_url }}&lt;/strong&gt;&lt;/p&gt;\n      {% for key, value in google_data.items() %}\n        &lt;p&gt;&lt;strong&gt;{{ key }}&lt;/strong&gt;: {{ value }}&lt;/p&gt;\n      {% endfor %}\n    &lt;/div&gt;\n  {% endif %}\n    &lt;p&gt;Click &lt;a href=&quot;/logout&quot;&gt;here&lt;/a&gt; to log out&lt;/p&gt;\n  {% endif %}\n\n&lt;/html&gt;</code>\n        </deckgo-highlight-code>\n<h3 id=\"code-walkthrough\" style=\"position:relative;\"><a href=\"#code-walkthrough\" aria-label=\"code walkthrough permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Walkthrough</h3>\n<p>I will walkthrough the code in chunks.</p>\n<deckgo-highlight-code language=\"python\" line-numbers=\"true\"  >\n          <code slot=\"code\">os.environ[&#39;OAUTHLIB_INSECURE_TRANSPORT&#39;] = &#39;1&#39;\n\npath = os.path.dirname(os.path.realpath(__file__))\ndb_path = os.path.join(path, &#39;app.db&#39;)\n\napp = Flask(__name__)\napp.config[&#39;SQLALCHEMY_DATABASE_URI&#39;] = &#39;sqlite:///&#39; + db_path\napp.config[&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;] = False\napp.config[&#39;SECRET_KEY&#39;] = &#39;YOUR-SECRET-KEY-HERE&#39;\n\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = &#39;google.login&#39;</code>\n        </deckgo-highlight-code>\n<p>Setting the <em>OAUTHLIB_INSECURE_TRANSPORT</em> environment variable allows the OAuth library to work even when using HTTP. Obviously, this should not be used in production.</p>\n<p>The rest is basic setup including the path to the sqlite database file. We will be using Flask-Login to handle the session-based logins. Setting the <em>login_view</em> here doesn’t do much but if you wanted to protect certain views, you can have your app automatically redirect the user to the appropriate login page.</p>\n<deckgo-highlight-code language=\"python\" line-numbers=\"true\"  >\n          <code slot=\"code\">class User(db.Model, UserMixin):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(256), unique=True)\n    name = db.Column(db.String(256))\n\n\nclass OAuth(OAuthConsumerMixin, db.Model):\n    provider_user_id = db.Column(db.String(256), unique=True)\n    user_id = db.Column(db.Integer, db.ForeignKey(&#39;user.id&#39;))\n    user = db.relationship(User)</code>\n        </deckgo-highlight-code>\n<p>We are using a separate model to store the OAuth token and related data. Using a separate model like this could allow you to support multiple authentication methods for a single user account.</p>\n<p>The <em>UserMixin</em> adds some methods required by Flask-Login. The <em>OAuthConsumerMixin</em> adds id, provider, created_at and token columns. I have included the <em>provider_user_id</em> column which will be the users unique identifier.</p>\n<deckgo-highlight-code language=\"python\" line-numbers=\"true\"  >\n          <code slot=\"code\">google_blueprint = make_google_blueprint(\n    client_id=&#39;YOUR-CLIENT-ID-HERE&#39;,\n    client_secret=&#39;YOUR-CLIENT-SECRET-HERE&#39;,\n    scope=[&#39;https://www.googleapis.com/auth/userinfo.email&#39;,\n           &#39;https://www.googleapis.com/auth/userinfo.profile&#39;],\n    offline=True,\n    reprompt_consent=True,\n    backend=SQLAlchemyBackend(OAuth, db.session, user=current_user)\n)\n\napp.register_blueprint(google_blueprint)</code>\n        </deckgo-highlight-code>\n<p>Here we are using Flask-Dance’s blueprint factory which we register to our app. Setting offline to true means we will receive a refresh_token allowing the access token to be renewed without the user having to go through the authorization flow again. Read more about ‘offline’ access tokens <a href=\"https://developers.google.com/identity/protocols/OAuth2WebServer#offline\">here</a>.</p>\n<p>The default backend uses the Flask session object to store OAuth tokens. Here we are using the SQLAlchemy backend. There are considerations to make when choosing where exactly you store tokens. <a href=\"https://auth0.com/docs/security/store-tokens\">Auth0.com</a> have a useful article discussing this.</p>\n<deckgo-highlight-code language=\"python\" line-numbers=\"true\"  >\n          <code slot=\"code\">@app.route(&#39;/&#39;)\ndef index():\n    google_data = None\n    user_info_endpoint = &#39;/oauth2/v2/userinfo&#39;\n    if current_user.is_authenticated and google.authorized:\n        google_data = google.get(user_info_endpoint).json()\n    return render_template(&#39;index.j2&#39;,\n                           google_data=google_data,\n                           fetch_url=google.base_url + user_info_endpoint)</code>\n        </deckgo-highlight-code>\n<p>The homepage of our application will simply display a link to login if the user has not done so already. When they are logged in, we fetch some user data (to prove we can) from the <em>userinfo</em> endpoint. We then display this data to the user.</p>\n<deckgo-highlight-code language=\"python\" line-numbers=\"true\"  >\n          <code slot=\"code\">@oauth_authorized.connect_via(google_blueprint)\ndef google_logged_in(blueprint, token):\n    resp = blueprint.session.get(&#39;/oauth2/v2/userinfo&#39;)\n    user_info = resp.json()\n    user_id = str(user_info[&#39;id&#39;])\n    oauth = OAuth.query.filter_by(provider=blueprint.name,\n                                  provider_user_id=user_id).first()\n    if not oauth:\n        oauth = OAuth(provider=blueprint.name,\n                      provider_user_id=user_id,\n                      token=token)\n    else:\n        oauth.token = token\n        db.session.add(oauth)\n        db.session.commit()\n        login_user(oauth.user)\n    if not oauth.user:\n        user = User(email=user_info[&quot;email&quot;],\n                    name=user_info[&quot;name&quot;])\n        oauth.user = user\n        db.session.add_all([user, oauth])\n        db.session.commit()\n        login_user(user)\n\n    return False</code>\n        </deckgo-highlight-code>\n<p>We are using the <em>@oauth_authorized</em> signal which allows us to perform some actions when the token has been successfully retrieved from the authorization server. It takes the specific blueprint as a first argument and the token as the second. This function could be generalised to take a different providers blueprint e.g. GitHub, Facebook. You could then just add multiple <em>oauth_authorized</em> decorators, one for each provider.</p>\n<p>In this function we are trying to load the OAuth object if it exists. If it does not exist, we create a new one and pair it with a new User too. We return False to prevent the default behaviour of Flask-Dance which would be to set the token on the backend (but we have done that ourselves).</p>\n<p>This kind of user creation is common. Sites usually do not expect a user to create an account and then tie the account to an OAuth provider. They wish to use their OAuth provider and have an account setup and be associated for them. But it is worth thinking about the different kinds of account creation and what the relationship between a user and a third-party authentication provider looks like.</p>\n<h2 id=\"the-running-application\" style=\"position:relative;\"><a href=\"#the-running-application\" aria-label=\"the running application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Running Application</h2>\n<p>Below are some screenshots of the application running.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ecebedcf50152859c986a1ed5bfc2551/5f1d2/hello_world.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 302px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACLUlEQVQoz2WOWU8aURTH54vUFHDkDWTfoSEkRRZZ+iAEUpZvwYPA92naN6s4srRWbW0aCEIYrcOkwswwo31A9pGlZ6ZJQ9vfvbnn3P+9538O8mxj47lEIpVKN/9DArpMtomi66JMJoPPKIgoimzJ5VqtdltE+TfryvYflEq1Wg1RpVIhYAAXnU5nMBhMJpPZbDaJWCwWG2C322xWEA0iRqMRcvgP/eBEYBKotFqtDseLYCgciUR2dwOh0Cuvx7Pj3nnpdvt9XjBQKBTQTaPROOz2LRS1ihaIXC7X6/W/jcHFKAI99vYiqXQ6kUgkk8l0Op0SN5BMpV4nErFYLB6PC52DwaDL5YIZIXE6neFwGH6QP7o9lr2jaPyWuCXadxTDsBzZofrD0dNiyc/n/HyBwDyhUMjv93s8nkAg4PV6fT5fNBp98/bdUeG4gGGHR4WD94dwFo4xUE6KpVK5UiyVYSOZTGY0GnW63fuHB5ZlmR5DUVSn06UpimU5GgJFMwzDcSxDw5Mg0DTNiSC5XPbb10sMw+pX9U+nwmo0mpVyBW9eNVs3jXq1WCx9/nJ5cXGOnWCVD6cfK8Wzs/PJjF+tVkg2l4MwGAxmU346mY7HY54XkuFwOJlMxqMRHEC/33987E+ns/n8CVgul0Lx/n6W45gb/Hu7znWIHkkStVqVIAgcb1FM7xpv1apVok2SZPu61ezd/4SalVgpFOfzeQhgxoPpfCE8LRarNf65rvMLRw2VOEvH74UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"sign in screen on home page\"\n        title=\"\"\n        src=\"/static/ecebedcf50152859c986a1ed5bfc2551/5f1d2/hello_world.png\"\n        srcset=\"/static/ecebedcf50152859c986a1ed5bfc2551/12f09/hello_world.png 148w,\n/static/ecebedcf50152859c986a1ed5bfc2551/e4a3f/hello_world.png 295w,\n/static/ecebedcf50152859c986a1ed5bfc2551/5f1d2/hello_world.png 302w\"\n        sizes=\"(max-width: 302px) 100vw, 302px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57f87ad3f9ec8a590979645660855ec5/2d7ab/login.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 526px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 122.97297297297298%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAACVElEQVQ4y7VTW28SURDe/4L41gKWiAlpSRWjMf4K/khLQloejD4QXmqRCmowjW+++ehTG5NKuRRhIQisC+wV2F32wgFnF3qyLVtim/hlzuycs/OdmZ2ZJV6+eB6JRMJPwuGn4e3H28FgcGtr02fBA1hfd1u4Z8Hlct13u9c8Xo/vgdfrJQKPAr6NDb/fHwqFEsnkp1wuk/14lMm8Sx+l0umDw8O3qVQKNpns++yHz8fHbxLJZ5uBkH/N/zBAxGKx3Z2d3Wg0Ho+fnJzWSLJ8USmVL4rFcqFYOsvnC6UynFSq1WqNbLZaP85+Jl7tv96L7u3HiZkNExOGJRNkLWQCtPUCoOtgYH9ieonZPwNTCLw3xoqqarqua5qmaiYg6HQlMBlJypAXhzxAEED6DKMbBlqCA3l+equcr5DhHHuoqqooivkJsAxDMx+6pQ37RXby4mLQLMtCZ+r1Olmrtn436yQJ+lelzHMc9nEgg8FxXK9vgeHanNHmEUhHQC0eUSKihAm6iYxzlmVZGavDMRooSJAXeqSagotzhdxnaZZjYAygTwpQVRXZRsJWs9mcT+DZAp37dvD1+5dmo5U/z58XCiD1RgNaB6VacOxVvRZ5XltwmkwWnYNzyAKunkezy3XyaDgaiINer99utzsdqtftURQFE31Tz5dbBfbU+i/wSC3iTC+Tdo68PEO4pXg7v9EhsiRJkDPd7UKLaboL9h+aNnvOsLBg24UNw4iDgRNZlnlBhL+C43nwEEQRBAyO4+EBtiTJq775VnCY7dX4b5HvQp7eCX8BrBxgC3xmYIcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Google login screen\"\n        title=\"\"\n        src=\"/static/57f87ad3f9ec8a590979645660855ec5/2d7ab/login.png\"\n        srcset=\"/static/57f87ad3f9ec8a590979645660855ec5/12f09/login.png 148w,\n/static/57f87ad3f9ec8a590979645660855ec5/e4a3f/login.png 295w,\n/static/57f87ad3f9ec8a590979645660855ec5/2d7ab/login.png 526w\"\n        sizes=\"(max-width: 526px) 100vw, 526px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a8c6df7b83c8e1ff6760118bcc075c14/17602/app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 88.51351351351352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAADYklEQVQ4y41SS1PbVhTWDyFhkTLNTCFAMLsUphtmuuYndaY0kDQJwYZ01y5IOu2UljQ2tQA7NsaJ9bJkWw/LtmRJtiUhvwbLsvyQe2ySvlb95tM35957zv2OzlxkbW1tY2NjfX3dt7LiW/HdnWJubu6TO3dmZmZuTXH79q3Z2dnP5hcW7i0ClhaXQQCIz+dbXV3d3Nzc3z/Yfb739Nnu7p7/4MWLwP6BP7C/Fwjs+f3Pdp8/fLTz5RefP/AtLS2vzN//dHH53sL8AvL0yZOd7e3Dly9VVZNluawoZVXTDfPKsiZfvQ4Ky1JZ+v67gP/b7e2dx1uPv3q4883W11sIzwu6bnAcl6ZIiqJyLCtLUi6XSb5LcSyL4ziGpSiSyOXY/mAw/jcQRVUNw1BVtT6FYZiNRt2yrmDfNA1JkjRoSVNrNd113bHnjf4BRFEUuLVYLHEcz7JcPl8gwAwnUimcIAgqnWZohuN5mpkgTWckSda0iud5E+datZoXhIIogn+lAjYqSKEIEGEEJanUte1pj5Ps0Wg4HP7dPFIth5tmvKagdT2qq6hWOmmasYocdju451JDh+zb+A0HExKgbgeDpdejkUj0KJON5HKRFBaMx38Jo69i8aOz858E4YKiwrB/mXxNkn9ADk2fUmkUJ0KqRjq90ug6iFwmgzz/FsNPBCGeyZznspFsLtpq8tfXYrsttNt8o8E1mxzEjQYLQas1ObLtotdBkd+OfxALCbie494mk8cpLIRhwbKKG3raMGjLykK245S63eKNAqHStkWvE0YSl284LprPxxn6lE6jLBcTxUQme16tkpUKqetpqLftArh1On+xADopjkSOaDrMZM4rFQpSdYOGs15PGo200VAdDpV+v+y6MtBxilOWug74FybFwdBhLPYzhodwPMTQKEGewJ9DQBInNI0Cs9kzno/B5K5Mpl7PAptNttVixzaKpIgzgginsDBMLhY/TiR+j0Z/JSgoSLDsBcdfFIvvhXxSLLyTZUIuE2WFVFVK06hxF0UY6ojEXhGpH99fHpZLpwXhjSKfda/JUT87dDPDHtN3aNABBF36hq6ddm3KsyNIw+Dahty2ig1LaF7xfacyHtfHI9MbGDccf9T/0nMQ3airYssyOzXDqlZNp9f/8BT/B/4EgB5liF5eAbQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"app after successful sign in\"\n        title=\"\"\n        src=\"/static/a8c6df7b83c8e1ff6760118bcc075c14/fcda8/app.png\"\n        srcset=\"/static/a8c6df7b83c8e1ff6760118bcc075c14/12f09/app.png 148w,\n/static/a8c6df7b83c8e1ff6760118bcc075c14/e4a3f/app.png 295w,\n/static/a8c6df7b83c8e1ff6760118bcc075c14/fcda8/app.png 590w,\n/static/a8c6df7b83c8e1ff6760118bcc075c14/17602/app.png 597w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>You can view the sample Flask application on GitHub <a href=\"https://github.com/Saturn/flask-google-auth-example\">here</a>.</p>\n<h2 id=\"useful-resources-and-further-reading\" style=\"position:relative;\"><a href=\"#useful-resources-and-further-reading\" aria-label=\"useful resources and further reading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Useful Resources and Further Reading</h2>\n<ul>\n<li><a href=\"https://github.com/singingwolfboy/flask-dance\">Flask-Dance</a></li>\n<li><a href=\"https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2\">An Introduction to OAuth 2 (Digital Ocean)</a></li>\n<li><a href=\"https://developers.google.com/identity/protocols/OpenIDConnect\">Google OpenID Connect Guide</a></li>\n<li><a href=\"https://auth0.com/docs/getting-started\">Auth0 docs</a></li>\n</ul>","frontmatter":{"title":"Adding Google Authentication to your Flask Application","date":"January 20, 2019"}}},"pageContext":{"slug":"/flask-google-login/"}},"staticQueryHashes":["3128451518"]}