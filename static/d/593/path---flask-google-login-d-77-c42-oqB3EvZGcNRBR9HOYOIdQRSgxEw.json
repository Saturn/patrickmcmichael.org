{"data":{"site":{"siteMetadata":{"title":null,"author":null}},"markdownRemark":{"id":"a425cf09-3302-57a1-924a-488df3835843","excerpt":"Hello.","html":"<p>Hello.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n\n<span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> render_template<span class=\"token punctuation\">,</span> redirect<span class=\"token punctuation\">,</span> url_for\n<span class=\"token keyword\">from</span> flask_sqlalchemy <span class=\"token keyword\">import</span> SQLAlchemy\n<span class=\"token keyword\">from</span> flask_login <span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>LoginManager<span class=\"token punctuation\">,</span> UserMixin<span class=\"token punctuation\">,</span>\n                         current_user<span class=\"token punctuation\">,</span> login_user<span class=\"token punctuation\">,</span> logout_user<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">from</span> flask_dance<span class=\"token punctuation\">.</span>consumer <span class=\"token keyword\">import</span> oauth_authorized\n<span class=\"token keyword\">from</span> flask_dance<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>google <span class=\"token keyword\">import</span> make_google_blueprint<span class=\"token punctuation\">,</span> google\n<span class=\"token keyword\">from</span> flask_dance<span class=\"token punctuation\">.</span>consumer<span class=\"token punctuation\">.</span>backend<span class=\"token punctuation\">.</span>sqla <span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>OAuthConsumerMixin<span class=\"token punctuation\">,</span>\n                                               SQLAlchemyBackend<span class=\"token punctuation\">)</span>\n\n\npath <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>dirname<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>realpath<span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ndb_path <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token string\">'app.db'</span><span class=\"token punctuation\">)</span>\n\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'SQLALCHEMY_DATABASE_URI'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'sqlite:///'</span> <span class=\"token operator\">+</span> db_path\napp<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'SQLALCHEMY_TRACK_MODIFICATIONS'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\napp<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'SECRET_KEY'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'aS3CR3Tk3y'</span>\n\ndb <span class=\"token operator\">=</span> SQLAlchemy<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\nlogin_manager <span class=\"token operator\">=</span> LoginManager<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nlogin_manager<span class=\"token punctuation\">.</span>init_app<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\nlogin_manager<span class=\"token punctuation\">.</span>login_view <span class=\"token operator\">=</span> <span class=\"token string\">'google.login'</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">,</span> UserMixin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token builtin\">id</span> <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>Column<span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>Integer<span class=\"token punctuation\">,</span> primary_key<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    email <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>Column<span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> unique<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    name <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>Column<span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuth</span><span class=\"token punctuation\">(</span>OAuthConsumerMixin<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    provider_user_id <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>Column<span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> unique<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    user_id <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>Column<span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>Integer<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>ForeignKey<span class=\"token punctuation\">(</span><span class=\"token string\">'user.id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    user <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span>relationship<span class=\"token punctuation\">(</span>User<span class=\"token punctuation\">)</span>\n\n\n@login_manager<span class=\"token punctuation\">.</span>user_loader\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_user</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> User<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\ngoogle_blueprint <span class=\"token operator\">=</span> make_google_blueprint<span class=\"token punctuation\">(</span>\n    client_id<span class=\"token operator\">=</span><span class=\"token string\">'603326531573-2nq3m6o3u1g6ogcf1qnh2j3523ucr5mf.apps.googleusercontent.com'</span><span class=\"token punctuation\">,</span>\n    client_secret<span class=\"token operator\">=</span><span class=\"token string\">'4IteqSIh-gA87knTCtNLhif0'</span><span class=\"token punctuation\">,</span>\n    scope<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'https://www.googleapis.com/auth/userinfo.email'</span><span class=\"token punctuation\">,</span>\n           <span class=\"token string\">'https://www.googleapis.com/auth/userinfo.profile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    offline<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    reprompt_consent<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    backend<span class=\"token operator\">=</span>SQLAlchemyBackend<span class=\"token punctuation\">(</span>OAuth<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">,</span> user<span class=\"token operator\">=</span>current_user<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span>register_blueprint<span class=\"token punctuation\">(</span>google_blueprint<span class=\"token punctuation\">)</span>\n\n\n@app<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    google_data <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n    <span class=\"token keyword\">if</span> current_user<span class=\"token punctuation\">.</span>is_authenticated <span class=\"token operator\">and</span> google<span class=\"token punctuation\">.</span>authorized<span class=\"token punctuation\">:</span>\n        google_data <span class=\"token operator\">=</span> google<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'/oauth2/v2/userinfo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> render_template<span class=\"token punctuation\">(</span><span class=\"token string\">'index.j2'</span><span class=\"token punctuation\">,</span> google_data<span class=\"token operator\">=</span>google_data<span class=\"token punctuation\">)</span>\n\n\n@app<span class=\"token punctuation\">.</span>route<span class=\"token punctuation\">(</span><span class=\"token string\">'/logout'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    logout_user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span>url_for<span class=\"token punctuation\">(</span><span class=\"token string\">'index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n@oauth_authorized<span class=\"token punctuation\">.</span>connect_via<span class=\"token punctuation\">(</span>google_blueprint<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">google_logged_in</span><span class=\"token punctuation\">(</span>blueprint<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    resp <span class=\"token operator\">=</span> blueprint<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'/oauth2/v2/userinfo'</span><span class=\"token punctuation\">)</span>\n    user_info <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    user_id <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>user_info<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    oauth <span class=\"token operator\">=</span> OAuth<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>filter_by<span class=\"token punctuation\">(</span>provider<span class=\"token operator\">=</span>blueprint<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n                                  provider_user_id<span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> oauth<span class=\"token punctuation\">:</span>\n        oauth <span class=\"token operator\">=</span> OAuth<span class=\"token punctuation\">(</span>provider<span class=\"token operator\">=</span>blueprint<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n                      provider_user_id<span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">,</span>\n                      token<span class=\"token operator\">=</span>token<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        oauth<span class=\"token punctuation\">.</span>token <span class=\"token operator\">=</span> token\n        <span class=\"token comment\"># db.session.add(oauth)</span>\n        <span class=\"token comment\"># db.session.commit()</span>\n        login_user<span class=\"token punctuation\">(</span>oauth<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> oauth<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">:</span>\n        user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">(</span>email<span class=\"token operator\">=</span>user_info<span class=\"token punctuation\">[</span><span class=\"token string\">\"email\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    name<span class=\"token operator\">=</span>user_info<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        oauth<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user\n        db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>add_all<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>user<span class=\"token punctuation\">,</span> oauth<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        login_user<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></code></pre></div>","frontmatter":{"title":"Signing in with a Google Account in your Flask application","date":"January 19, 2019"}}},"pageContext":{"slug":"/flask-google-login/","previous":{"fields":{"slug":"/hello/"},"frontmatter":{"title":"Hello"}},"next":null}}